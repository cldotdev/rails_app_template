name: "rails-app-dev"

x-common: &common
  restart: unless-stopped
  env_file:
    - .env.example
    - .env

x-pg-common: &pg-common
  image: postgres:18-alpine
  healthcheck:
    test: ["CMD-SHELL", "pg_isready"]
    interval: 10s
    timeout: 5s
    retries: 5
    start_period: 10s
  expose:
    - 5432

x-redis-common: &redis-common
  image: valkey/valkey:8-alpine
  healthcheck:
    test: ["CMD", "redis-cli", "ping"]
    interval: 10s
    timeout: 5s
    retries: 3
    start_period: 5s
  expose:
    - 6379

x-rails-common: &rails-common
  image: local/rails-app:dev
  build:
    context: .
    args:
      RAILS_ENV: development
      BUNDLE_DEPLOYMENT: "false"
      BUNDLE_WITHOUT: ""
      APP_UID: ${APP_UID:-1000}
      APP_GID: ${APP_GID:-1000}
  depends_on:
    pg:
      condition: service_healthy
    redis_cache:
      condition: service_healthy
    redis_cable:
      condition: service_healthy
    redis_session:
      condition: service_healthy
    redis_queue:
      condition: service_healthy
  secrets:
    - mailer_smtp_password
  volumes:
    - ./.srv/server/storage:/rails/storage
  develop:
    watch:
      - action: sync
        path: .
        target: /rails
        ignore:
          # Version control
          - .git/
          - .github/

          # Dependencies
          - .bundle/
          - vendor/bundle/

          # Environment & secrets
          - .env*
          - .secrets/

          # Runtime data
          - .srv/
          - log/
          - tmp/
          - storage/

          # Caches
          - .cache/
          - .rubocop-*
          - .ruby-lsp/

          # Editor & IDE
          - .claude/
          - .serena/
          - CLAUDE.md
          - .vscode/
          - .idea/
          - .devcontainer/

          # Docker files
          - .dockerignore
          - Dockerfile*
          - compose.yaml
          - compose.yml
          - compose.*.yaml
          - compose.*.yml

          # Deployment
          - .kamal/
          - bin/deploy

services:
  pg:
    <<: [*common, *pg-common]
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_USER: ${APP_POSTGRES_USER}
      POSTGRES_DB: ${APP_POSTGRES_DB}
    volumes:
      - ./.srv/pg/data:/var/lib/postgresql
  redis_cache:
    <<: [*common, *redis-common]
    command:
      - sh
      - -c
      - |
        redis-server \
          --maxmemory 1gb \
          --maxmemory-policy allkeys-lru \
          --save ""
  redis_cable:
    <<: [*common, *redis-common]
    command:
      - sh
      - -c
      - |
        redis-server \
          --maxmemory 512mb \
          --maxmemory-policy noeviction \
          --save ""
  redis_session:
    <<: [*common, *redis-common]
    volumes:
      - ./.srv/redis_session/data:/data
    command:
      - sh
      - -c
      - |
        redis-server \
          --maxmemory 512mb \
          --maxmemory-policy noeviction \
          --appendonly yes \
          --appendfsync everysec
  redis_queue:
    <<: [*common, *redis-common]
    volumes:
      - ./.srv/redis_queue/data:/data
    command:
      - sh
      - -c
      - |
        redis-server \
          --maxmemory 512mb \
          --maxmemory-policy noeviction \
          --appendonly yes \
          --appendfsync everysec
  server:
    <<: [*common, *rails-common]
    healthcheck:
      test: ['CMD', "curl", "-fsS", "http://localhost:3000/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    stop_signal: SIGTERM
    stop_grace_period: 10s
    environment:
      APP_RAILS_MAX_THREADS: 5
      APP_RAILS_MIN_THREADS: 5
      APP_WEB_CONCURRENCY: 0
      APP_SESSION_COOKIE_SAME_SITE: none
    expose:
      - 3000
  worker:
    <<: [*common, *rails-common]
    depends_on:
      server:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'pgrep', '-f', 'sidekiq']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    stop_signal: SIGTERM
    stop_grace_period: 10s
    environment:
      APP_DB_MIGRATION: false
      APP_SIDEKIQ_CONCURRENCY: 2
    command: ["./bin/jobs"]
  cloudflared:
    <<: *common
    image: cloudflare/cloudflared:latest
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "--metrics", "localhost:2000", "ready"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    command: tunnel --metrics 0.0.0.0:2000 run --token-file /run/secrets/cf_tunnel_token
    secrets:
      - cf_tunnel_token

secrets:
  mailer_smtp_password:
    file: ./.secrets/mailer_smtp_password
  cf_tunnel_token:
    file: ./.secrets/cf_tunnel_token
